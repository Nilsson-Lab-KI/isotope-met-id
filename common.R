#
#  Some functions commonly used in these scripts
#
# NOTE: Some of these could be moved to the remn package
#

library(dplyr)

# data folder common paths

input_data_path <- "00_input_data"
preprocessed_data_path <- "01_preprocessed_data"
mi_data_path <- "02_mi_data"

# constants
proton_mass <- 1.007276466621
h2o_mass <- 18.010564683
nh4_mass <- 18.034374132
ppm_tolerance <- 10


# Read peak area data from the HMEC isotope tracing experiment
read_hmec_peak_areas <- function()
{
    return(
        read.table(
            file.path(preprocessed_data_path, "qc-peak-areas.tsv"),
            sep = "\t", header = TRUE, comment.char = "", quote = ""
        )
    )
}

# Read peak list from the HMEC isotope tracing experiment
read_hmec_peak_list <- function()
{
    return(
        read.table(
            file.path(preprocessed_data_path, "qc-peak-list.tsv"),
            sep = "\t", header = TRUE, comment.char = "", quote = ""
        )
    )
}


get_mid_matrix <- function(mi_data, peak_id, experiments = NULL)
{
    return(
        do.call(cbind,
                lapply(
                    experiments,
                    function(e) get_mids(mi_data, peak_id, e)
                )
        )
    )
}


# convolute MID matrices column by column
convolute_all <- function(mids_1, mids_2)
{
    sapply(
        1:ncol(mids_1),
        function(i) convolute(mids_1[, i], mids_2[, i])
    )
}

# write matrix as PNG image (for Illustrator) after applying a color function
# such as those generated by colorRamp()
# rows of the matrix are laid out from top to bottom.
write_image <- function(file_path, mat, color_fn)
{
    png::writePNG(
        aperm(
            apply(mat, c(1,2), color_fn) / 255,
            c(2,3,1)
        ),
        file_path
    )
}

reverse_rows <- function(mat)
{
    return(mat[nrow(mat):1, ])
}

# write an MID matrix, dropping M+0 and rescaling to [0, 1]
write_mid_matrix_image <- function(file_name, mids)
{
    mat <- reverse_rows(c13correct_cols(mids)[-1, ])
    cat("Scaling image to max = ", max(mat))
    write_image(
        file_name, mat / max(mat), colorRamp(c("white", "red"))
    )
}


